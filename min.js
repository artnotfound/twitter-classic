function reorderTimeline(e,t,i){window.makingClassic=!0;for(var n=[],r=0;r<e.length;r++)e[r].id!==t[r].id&&(e[r].elem.before(t[r].elem.clone()),n.push(e[r].elem));n.forEach(function(e){e.remove()}),window.makingClassic=!1,setClassic()}function sortByTime(e){return e.sort(function(e,t){return-(new Date(e.time).getTime()-new Date(t.time).getTime())})}function getTimeline(e){killPromoted();var t=[],i=null,n=".stream > .stream-items > *";return"all"!==e&&(n+=":not(.sorted-classic)"),$(n).each(function(){var e=$(this).find($(".original-tweet"))[0],n=$(e).attr("data-tweet-id"),r=$(e).find($("*[data-time-ms]"))[0];if(r){var a=parseInt($(r).attr("data-time-ms"));$(this).hasClass("sorted-classic")||($(this).find(".js-retweet-text").length&&(a=i?i-1e3:(new Date).getTime()),a===i&&(a-=1e3),$(r).attr("data-time-ms",a)),i=a,t.push({id:n,elem:$(this),time:a,text:$($(this).find(".original-tweet .tweet-text")[0]).text(),prettyTime:new Date(a)})}}),t}function killPromoted(){$(".stream > .stream-items > *").each(function(){$(this).find(".promoted-tweet").length&&$(this).remove()})}function testSorting(){function e(e){for(var t=e.length-1;t>0;t--){var i=Math.floor(Math.random()*(t+1)),n=e[t];e[t]=e[i],e[i]=n}return e}killPromoted();var t=getTimeline("all"),i=e(t.slice(0));reorderTimeline(t,i,!0)}function isEqual(e,t){var i=!0;return e.forEach(function(e,n){e.id!==t[n].id&&(i=!1)}),i}function setClassic(){$(".stream > .stream-items > *:not(.sorted-classic)").addClass("sorted-classic")}function makeClassic(e){var t=getTimeline(e),i=sortByTime(t.slice(0));isEqual(t,i)?setClassic():reorderTimeline(t,i)}function createKeybindings(){var e=!1;$(document).keydown(function(t){16===t.keyCode&&(e=!0)}),$(document).keyup(function(t){16===t.keyCode&&(e=!1),83===t.keyCode&&e?testSorting():67===t.keyCode&&e&&makeClassic("all")})}function bindStream(){var e,t=getStreamCount();$(".stream > .stream-items").bind("DOMNodeInserted",function(i){var n=i.currentTarget.childElementCount;return i.target.innerHTML.indexOf("promoted-tweet")>-1?($(i.target).parents("li.stream-item").remove(),void t++):void(window.makingClassic||n===t||n>t&&(log("TWEET ADDED ... ","twitter"),clearTimeout(e),t=n,e=setTimeout(makeClassic,300)))}),$(".stream > .stream-items").bind("DOMNodeRemoved",function(e){var i=e.currentTarget.childElementCount;t>i&&(t=i)})}function getStreamCount(){return $(".stream > .stream-items > *").length}function init(){killPromoted(),makeClassic(),bindStream(),createKeybindings()}function isHomepage(){var e=/twitter.com(.*)/.exec(window.location.href);return e[1].length<=1&&$("body").hasClass("logged-in")}function waitForHomePage(){if(!isHomepage()){var e,t=function(){isHomepage()&&(clearInterval(e),init())};e=setInterval(t,1e3)}}$(document).ready(function(){chrome.runtime.sendMessage({text:"is this thing on?"},function(e){e&&($("#global-nav-home").on("click",waitForHomePage),isHomepage()&&init())})});
